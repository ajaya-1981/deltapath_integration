"use strict";var __awaiter=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))},__generator=this&&this.__generator||function(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},Deltapath=function(){function t(e,n,r,o,i,s){void 0===o&&(o="http"),void 0===i&&(i=30),void 0===s&&(s=1),this.hostname=e,this.username=n,this.protocol=o,this.actionTimeout=i,this.reconnectInterval=s,this.uuid=0,this.handlers=[],this.http=new t.HTTP(this),this.ws=new t.Socket(this),this.token=new t.Token(this),this.mutex=new t.Mutex,this.isConnected=!1,this.isConnecting=!1;var a=0;for(var c in arguments){if(parseInt(c)<3){var u=arguments[c];if(null==u||""===u)throw new Error("Invalid arguments: argument ["+c+"] cannot be empty")}a++}if(a<3)throw new Error("Too few arguments");if("http"!==o&&"https"!==o)throw new Error("Invalid protocol");if(null!=i&&""!==i.toString()||(this.actionTimeout=i=30),null!=s&&""!==s.toString()||(this.reconnectInterval=s=1),NaN==i||i<0)throw new Error("Invalid action timeout");if(NaN==s||s<0)throw new Error("Invalid reconnection interval");this.secret=this.md5(this.md5(r)+"@deltapath"),this.restUrl=o+"://"+e+"/RESTful/index.php",this.wsUrl=("http"===o?"ws":"wss")+"://"+e+":"+("http"===o?"12121":"12122")+"/sockjs/websocket"}return t.prototype.connect=function(){return __awaiter(this,void 0,void 0,(function(){var t,e,n=this;return __generator(this,(function(r){switch(r.label){case 0:return[4,this.mutex.lock()];case 1:t=r.sent();try{if(this.isConnecting)return[2,new Error("Already connecting.")];this.isConnecting=!0}finally{t()}r.label=2;case 2:return r.trys.push([2,5,,6]),this.isConnected?(this.isConnecting=!1,[2,new Error("Already connected.")]):[4,this.token.refresh(!0)];case 3:return r.sent()?[4,new Promise((function(t){var e=null,r={onclose:function(o){switch(!0){case!n.isConnected:case 4999===o.code&&(!o.reason||o.reason===n.username+" quit"):case n.reconnectInterval<1:return n.isConnected=!1,n.isConnecting=!1,void t(null!=e?e:new Error(o.toString()))}__awaiter(n,void 0,void 0,(function(){var t,e=this;return __generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),4888!==o.code||o.reason&&"Authentication failed."!==o.reason?[3,2]:[4,this.token.refresh()];case 1:n.sent(),n.label=2;case 2:return[3,4];case 3:return(t=n.sent())instanceof Error&&"Token destroyed, please connect again."===t.message?[2]:[3,4];case 4:return setTimeout((function(){e.ws.open(r)}),1e3*this.reconnectInterval),[2]}}))}))},onerror:function(t){e=new Error(t.toString()),n.ws.close(1011,t.toString())},onmessage:function(t){var e,r,o,i,s=0;try{i=JSON.parse(t.data)}catch(t){return}i.uuid&&(s=parseInt(i.uuid)),NaN!=s&&n.handlers[s]&&n.handlers[s](i);var a="string"==typeof i.e?i.e:"";a&&((a.includes("CallStatus")||"Meetme"===a)&&(null===(e=n.onCallUpdate)||void 0===e||e.call(n,i)),"PcPresence"===a&&(null===(r=n.onPresenceUpdate)||void 0===r||r.call(n,i)),null===(o=n.defaultEventHandler)||void 0===o||o.call(n,i))},onopen:function(r){e=null,__awaiter(n,void 0,void 0,(function(){var e,n,r,o=this;return __generator(this,(function(i){switch(i.label){case 0:return n=(e=this.ws).send,r={cmd:"apiAuth"},[4,this.token.string()];case 1:return n.apply(e,[(r.token=i.sent(),r.subscribeOnly=["PcPresence","Meetme","VMStatus","QueueStatus","CallStatus","AgentStatus","QueueCallStatus"],r),function(e){var n;if(!0===e.success){var r=o.isConnected;o.isConnected=!0,o.isConnecting=!1,t(null),r||null===(n=o.onInitialize)||void 0===n||n.call(o,e)}else t(new Error("Authentication failed.")),o.ws.close(4888,"Authentication failed.")}]),[2]}}))}))}};n.ws.open(r)}))]:(this.isConnecting=!1,[2,new Error("Failed to refresh token.")]);case 4:return[2,r.sent()];case 5:return(e=r.sent())instanceof Error?[2,e]:[2,new Error(e)];case 6:return[2]}}))}))},t.prototype.disconnect=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return this.ws.close(4999,this.username+" quit"),[4,this.token.destroy()];case 1:return[2,t.sent()]}}))}))},t.prototype.dispatch=function(t){return __awaiter(this,void 0,void 0,(function(){var e=this;return __generator(this,(function(n){switch(n.label){case 0:if(!this.isConnected)throw new Error("Not connected.");if("object"!=typeof t||null===t||Array.isArray(t))throw new Error("Invalid packet.");return[4,new Promise((function(n,r){e.ws.send(t,(function(t){return n(t)})),setTimeout((function(){r(new Error("Action timeout."))}),1e3*e.actionTimeout)}))];case 1:return[2,n.sent()]}}))}))},t.prototype.getCallList=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return"GET",[4,this.http.fetch(this.restUrl+"/frsipswitchboard/call/list"+(t?"/moreinfo":""),{method:"GET"})];case 1:return[2,e.sent()]}}))}))},t.prototype.makeCall=function(t,e,n){return __awaiter(this,void 0,void 0,(function(){var r;return __generator(this,(function(o){switch(o.label){case 0:return"POST",r=JSON.stringify({to:t,device:e,account_code:n}),[4,this.http.fetch(this.restUrl+"/frsipswitchboard/call/make",{method:"POST",body:r})];case 1:return[2,o.sent()]}}))}))},t.prototype.answerCall=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:return"POST",n=JSON.stringify({channelid:t,mac:e}),[4,this.http.fetch(this.restUrl+"/frsipswitchboard/call/answer",{method:"POST",body:n})];case 1:return[2,r.sent()]}}))}))},t.prototype.holdCall=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:return"POST",n=JSON.stringify({channelid:t,mac:e}),[4,this.http.fetch(this.restUrl+"/frsipswitchboard/call/hold",{method:"POST",body:n})];case 1:return[2,r.sent()]}}))}))},t.prototype.resumeCall=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:return"POST",n=JSON.stringify({channelid:t,mac:e}),[4,this.http.fetch(this.restUrl+"/frsipswitchboard/call/resume",{method:"POST",body:n})];case 1:return[2,r.sent()]}}))}))},t.prototype.hangupCall=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:return"POST",n=JSON.stringify({channelid:t,multiple:e}),[4,this.http.fetch(this.restUrl+"/frsipswitchboard/call/hangup",{method:"POST",body:n})];case 1:return[2,r.sent()]}}))}))},t.prototype.md5=function(t){var e,n,r,o,i,s,a,c,u,h=function(t,e){return t<<e|t>>>32-e},l=function(t,e){var n,r,o,i,s;return o=2147483648&t,i=2147483648&e,s=(1073741823&t)+(1073741823&e),(n=1073741824&t)&(r=1073741824&e)?2147483648^s^o^i:n|r?1073741824&s?3221225472^s^o^i:1073741824^s^o^i:s^o^i},d=function(t,e,n,r,o,i,s){return t=l(t,l(l(function(t,e,n){return t&e|~t&n}(e,n,r),o),s)),l(h(t,i),e)},f=function(t,e,n,r,o,i,s){return t=l(t,l(l(function(t,e,n){return t&n|e&~n}(e,n,r),o),s)),l(h(t,i),e)},p=function(t,e,n,r,o,i,s){return t=l(t,l(l(function(t,e,n){return t^e^n}(e,n,r),o),s)),l(h(t,i),e)},w=function(t,e,n,r,o,i,s){return t=l(t,l(l(function(t,e,n){return e^(t|~n)}(e,n,r),o),s)),l(h(t,i),e)},v=function(t){var e,n="",r="";for(e=0;e<=3;e++)n+=(r="0"+(t>>>8*e&255).toString(16)).substr(r.length-2,2);return n},_=Array();for(_=function(t){for(var e,n=t.length,r=n+8,o=16*((r-r%64)/64+1),i=Array(o-1),s=0,a=0;a<n;)s=a%4*8,i[e=(a-a%4)/4]=i[e]|t.charCodeAt(a)<<s,a++;return s=a%4*8,i[e=(a-a%4)/4]=i[e]|128<<s,i[o-2]=n<<3,i[o-1]=n>>>29,i}(t=function(t){t=t.replace(/\r\n/g,"\n");for(var e="",n=0;n<t.length;n++){var r=t.charCodeAt(n);r<128?e+=String.fromCharCode(r):r>127&&r<2048?(e+=String.fromCharCode(r>>6|192),e+=String.fromCharCode(63&r|128)):(e+=String.fromCharCode(r>>12|224),e+=String.fromCharCode(r>>6&63|128),e+=String.fromCharCode(63&r|128))}return e}(t)),s=1732584193,a=4023233417,c=2562383102,u=271733878,e=0;e<_.length;e+=16)n=s,r=a,o=c,i=u,s=d(s,a,c,u,_[e+0],7,3614090360),u=d(u,s,a,c,_[e+1],12,3905402710),c=d(c,u,s,a,_[e+2],17,606105819),a=d(a,c,u,s,_[e+3],22,3250441966),s=d(s,a,c,u,_[e+4],7,4118548399),u=d(u,s,a,c,_[e+5],12,1200080426),c=d(c,u,s,a,_[e+6],17,2821735955),a=d(a,c,u,s,_[e+7],22,4249261313),s=d(s,a,c,u,_[e+8],7,1770035416),u=d(u,s,a,c,_[e+9],12,2336552879),c=d(c,u,s,a,_[e+10],17,4294925233),a=d(a,c,u,s,_[e+11],22,2304563134),s=d(s,a,c,u,_[e+12],7,1804603682),u=d(u,s,a,c,_[e+13],12,4254626195),c=d(c,u,s,a,_[e+14],17,2792965006),s=f(s,a=d(a,c,u,s,_[e+15],22,1236535329),c,u,_[e+1],5,4129170786),u=f(u,s,a,c,_[e+6],9,3225465664),c=f(c,u,s,a,_[e+11],14,643717713),a=f(a,c,u,s,_[e+0],20,3921069994),s=f(s,a,c,u,_[e+5],5,3593408605),u=f(u,s,a,c,_[e+10],9,38016083),c=f(c,u,s,a,_[e+15],14,3634488961),a=f(a,c,u,s,_[e+4],20,3889429448),s=f(s,a,c,u,_[e+9],5,568446438),u=f(u,s,a,c,_[e+14],9,3275163606),c=f(c,u,s,a,_[e+3],14,4107603335),a=f(a,c,u,s,_[e+8],20,1163531501),s=f(s,a,c,u,_[e+13],5,2850285829),u=f(u,s,a,c,_[e+2],9,4243563512),c=f(c,u,s,a,_[e+7],14,1735328473),s=p(s,a=f(a,c,u,s,_[e+12],20,2368359562),c,u,_[e+5],4,4294588738),u=p(u,s,a,c,_[e+8],11,2272392833),c=p(c,u,s,a,_[e+11],16,1839030562),a=p(a,c,u,s,_[e+14],23,4259657740),s=p(s,a,c,u,_[e+1],4,2763975236),u=p(u,s,a,c,_[e+4],11,1272893353),c=p(c,u,s,a,_[e+7],16,4139469664),a=p(a,c,u,s,_[e+10],23,3200236656),s=p(s,a,c,u,_[e+13],4,681279174),u=p(u,s,a,c,_[e+0],11,3936430074),c=p(c,u,s,a,_[e+3],16,3572445317),a=p(a,c,u,s,_[e+6],23,76029189),s=p(s,a,c,u,_[e+9],4,3654602809),u=p(u,s,a,c,_[e+12],11,3873151461),c=p(c,u,s,a,_[e+15],16,530742520),s=w(s,a=p(a,c,u,s,_[e+2],23,3299628645),c,u,_[e+0],6,4096336452),u=w(u,s,a,c,_[e+7],10,1126891415),c=w(c,u,s,a,_[e+14],15,2878612391),a=w(a,c,u,s,_[e+5],21,4237533241),s=w(s,a,c,u,_[e+12],6,1700485571),u=w(u,s,a,c,_[e+3],10,2399980690),c=w(c,u,s,a,_[e+10],15,4293915773),a=w(a,c,u,s,_[e+1],21,2240044497),s=w(s,a,c,u,_[e+8],6,1873313359),u=w(u,s,a,c,_[e+15],10,4264355552),c=w(c,u,s,a,_[e+6],15,2734768916),a=w(a,c,u,s,_[e+13],21,1309151649),s=w(s,a,c,u,_[e+4],6,4149444226),u=w(u,s,a,c,_[e+11],10,3174756917),c=w(c,u,s,a,_[e+2],15,718787259),a=w(a,c,u,s,_[e+9],21,3951481745),s=l(s,n),a=l(a,r),c=l(c,o),u=l(u,i);return(v(s)+v(a)+v(c)+v(u)).toLowerCase()},t.Mutex=function(){function t(){this.current=Promise.resolve()}return t.prototype.lock=function(){var t,e=new Promise((function(e){t=function(){return e()}})),n=this.current.then((function(){return t}));return this.current=e,n},t}(),t.Token=function(){function t(t){this.deltapath=t,this.destroyed=!1,this._t=""}return t.prototype.string=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(e){switch(e.label){case 0:return[4,this.deltapath.mutex.lock()];case 1:t=e.sent();try{if(this.destroyed)throw new Error("Token destroyed, please connect again.");return[2,this._t]}finally{t()}return[2]}}))}))},t.prototype.refresh=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n,r,o,i,s;return __generator(this,(function(a){switch(a.label){case 0:return[4,this.deltapath.mutex.lock()];case 1:e=a.sent(),a.label=2;case 2:if(a.trys.push([2,8,9,10]),this.destroyed){if(!0!==t)throw new Error("Token destroyed, please connect again.");this.destroyed=!1}return n=this.deltapath.restUrl,r=new Headers({"Content-Type":"application/json"}),o=void 0,i=void 0,this._t?[3,4]:[4,fetch(n+"/api/token/request",{method:"POST",headers:r,body:JSON.stringify({username:this.deltapath.username,data:this.deltapath.secret})})];case 3:return o=a.sent(),[3,6];case 4:return r.append("X-frSIP-API-Token",this._t),[4,fetch(n+"/put/api/token/refresh",{method:"POST",headers:r,body:JSON.stringify({username:this.deltapath.username})})];case 5:o=a.sent(),a.label=6;case 6:return[4,o.json()];case 7:return(i=a.sent()).success?(this._t=i.token,[2,!0]):[2,!1];case 8:if((s=a.sent())instanceof Error&&"Token destroyed, please connect again."===s.message)throw s;return[2,!1];case 9:return e(),[7];case 10:return[2]}}))}))},t.prototype.destroy=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(e){switch(e.label){case 0:return[4,this.deltapath.mutex.lock()];case 1:t=e.sent(),e.label=2;case 2:return e.trys.push([2,,4,5]),this.destroyed||(this.destroyed=!0),[4,fetch(this.deltapath.restUrl+"/delete/api/token/expire",{method:"POST",headers:{"X-frSIP-API-Token":this._t,"Content-Type":"application/json"},body:JSON.stringify({username:this.deltapath.username})})];case 3:return e.sent(),this._t="",[3,5];case 4:return t(),[7];case 5:return[2]}}))}))},t}(),t.Socket=function(){function t(t){this.deltapath=t,this._sock=null}return t.prototype.open=function(t){this._sock=new WebSocket(this.deltapath.wsUrl),this._sock.onclose=t.onclose,this._sock.onerror=t.onerror,this._sock.onmessage=t.onmessage,this._sock.onopen=t.onopen},t.prototype.close=function(t,e){this._sock&&this._sock.close(t,e)},t.prototype.send=function(t,e){if(!this._sock)throw new Error("WebSocket not initialized.");this.deltapath.handlers[++this.deltapath.uuid]=e,t.uuid=this.deltapath.uuid.toString(),this._sock.send(JSON.stringify(t))},t}(),t.HTTP=function(){function t(t){this.deltapath=t}return t.prototype.fetch=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n=this;return __generator(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(r,o){var i=new AbortController,s=i.signal;e.signal=s,__awaiter(n,void 0,void 0,(function(){var n,i,s,a,c,u;return __generator(this,(function(h){switch(h.label){case 0:h.trys.push([0,6,,7]),h.label=1;case 1:if(!this.deltapath.isConnected)throw new Error("Not connected.");return e.method||(e.method="GET"),i=Headers.bind,u={"Content-Type":"application/json"},s="X-frSIP-API-Token",[4,this.deltapath.token.string()];case 2:return n=new(i.apply(Headers,[void 0,(u[s]=h.sent(),u)])),"POST"!==e.method.toUpperCase()&&"PUT"!==e.method.toUpperCase()&&n.delete("Content-Type"),e.headers=n,[4,fetch(t,e)];case 3:return 401!==(a=h.sent()).status?(r(a),[2]):[4,this.deltapath.token.refresh()];case 4:return h.sent(),[3,1];case 5:return[3,7];case 6:return(c=h.sent())instanceof Error?o(c):o(new Error(c.toString())),[2];case 7:return[2]}}))})),setTimeout((function(){i.abort()}),1e3*n.deltapath.actionTimeout)}))];case 1:return[2,r.sent()]}}))}))},t}(),t}();
